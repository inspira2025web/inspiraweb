<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - INSPIRA 2025</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="icon" href="https://placehold.co/32x32/541C1C/FFFFFF?text=I25" type="image/x-icon">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #541C1C, #6B2E2E, #874C1B, #541C1C);
            background-size: 400% 400%;
            animation: waveFlag 10s ease infinite;
        }
        @keyframes waveFlag { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .form-input { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .form-input:focus { background-color: rgba(255, 255, 255, 0.2); border-color: #F28C1A; outline: none; box-shadow: 0 0 0 3px rgba(242, 140, 26, 0.5); }
        .ticket-gradient { background: linear-gradient(135deg, #874C1B, #6B2E2E, #541C1C); }
        .btn-brand { background-color: #F28C1A; transition: all 0.3s ease; }
        .btn-brand:hover { background-color: #d87e17; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .form-container { display: none; }
        .form-container.active { display: block; }
        .dp-card { background: linear-gradient(135deg, #8a5a2b, #7a3d3d); }
    </style>
</head>

<body class="animated-gradient text-white">

    <main id="page-content" class="min-h-screen w-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
        
        <!-- Loading Spinner -->
        <div id="loader" class="hidden text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Loading...</p>
        </div>

        <!-- Auth Forms Container -->
        <div id="auth-section">
            <!-- Sign In Form -->
            <div id="signin-container" class="form-container active w-full max-w-md mx-auto">
                <div class="bg-white/10 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center mb-2">Welcome Back!</h2>
                    <p class="text-center text-gray-300 mb-6">Sign in to get your ticket and DP.</p>
                    <form id="signin-form" class="space-y-6">
                        <div>
                            <label for="signin-email" class="block mb-2 text-sm font-medium text-gray-200">Email Address</label>
                            <input type="email" id="signin-email" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="your.email@example.com" required>
                        </div>
                        <div>
                            <label for="signin-password" class="block mb-2 text-sm font-medium text-gray-200">Password</label>
                            <input type="password" id="signin-password" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="••••••••" required>
                        </div>
                        <p id="signin-error" class="text-red-400 text-sm mt-2 hidden"></p>
                        <button type="submit" class="w-full btn-brand text-white font-bold py-3 px-5 rounded-lg text-lg">
                            <i class="bi bi-box-arrow-in-right mr-2"></i> Sign In
                        </button>
                    </form>
                    <div class="text-center mt-6 text-sm">
                        <p class="text-gray-300">Don't have an account? <a href="#" id="show-signup" class="font-medium text-orange-400 hover:underline">Sign Up</a></p>
                        <p class="text-gray-300 mt-2"><a href="#" id="show-forgot" class="font-medium text-orange-400 hover:underline">Forgot Password?</a></p>
                    </div>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div id="signup-container" class="form-container w-full max-w-md mx-auto">
                <div class="bg-white/10 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center mb-2">Create Account</h2>
                    <p class="text-center text-gray-300 mb-6">First, let's check if you are registered for the event.</p>
                    <form id="signup-form" class="space-y-6">
                         <div>
                            <label for="signup-reg" class="block mb-2 text-sm font-medium text-gray-200">Registration Number</label>
                            <input type="text" id="signup-reg" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="e.g., ASP/2024/079" required>
                        </div>
                        <div>
                            <label for="signup-name" class="block mb-2 text-sm font-medium text-gray-200">Full Name</label>
                            <input type="text" id="signup-name" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="Your full name" required>
                        </div>
                        <div>
                            <label for="signup-email" class="block mb-2 text-sm font-medium text-gray-200">Email Address</label>
                            <input type="email" id="signup-email" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="your.email@example.com" required>
                        </div>
                        <div>
                            <label for="signup-password" class="block mb-2 text-sm font-medium text-gray-200">Create Password</label>
                            <input type="password" id="signup-password" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="Must be at least 6 characters" required>
                        </div>
                        <p id="signup-error" class="text-red-400 text-sm mt-2 hidden"></p>
                        <button type="submit" class="w-full btn-brand text-white font-bold py-3 px-5 rounded-lg text-lg">
                           <i class="bi bi-person-plus-fill mr-2"></i> Sign Up
                        </button>
                    </form>
                    <div class="text-center mt-6 text-sm">
                        <p class="text-gray-300">Already have an account? <a href="#" id="show-signin" class="font-medium text-orange-400 hover:underline">Sign In</a></p>
                    </div>
                </div>
            </div>
             <!-- Forgot Password Form -->
            <div id="forgot-container" class="form-container w-full max-w-md mx-auto">
                <div class="bg-white/10 backdrop-blur-sm p-8 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center mb-2">Reset Password</h2>
                    <p class="text-center text-gray-300 mb-6">Enter your email to receive a password reset link.</p>
                    <form id="forgot-form" class="space-y-6">
                        <div>
                            <label for="forgot-email" class="block mb-2 text-sm font-medium text-gray-200">Email Address</label>
                            <input type="email" id="forgot-email" class="form-input w-full px-4 py-3 rounded-lg text-white" placeholder="your.email@example.com" required>
                        </div>
                        <p id="forgot-message" class="text-green-400 text-sm mt-2 hidden"></p>
                        <p id="forgot-error" class="text-red-400 text-sm mt-2 hidden"></p>
                        <button type="submit" class="w-full btn-brand text-white font-bold py-3 px-5 rounded-lg text-lg">
                            Send Reset Link
                        </button>
                    </form>
                    <div class="text-center mt-6 text-sm">
                        <p class="text-gray-300">Remembered your password? <a href="#" id="show-signin-2" class="font-medium text-orange-400 hover:underline">Sign In</a></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logged In Section -->
        <div id="app-section" class="hidden w-full max-w-4xl mx-auto text-center">
            <h2 class="text-3xl md:text-4xl font-bold">Welcome, <span id="user-name-display"></span>!</h2>
            <p class="text-gray-300 mb-8">Your event pass and profile picture are ready.</p>
            <div class="flex justify-end mb-4">
                <button id="signout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="bi bi-box-arrow-left mr-2"></i> Sign Out
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Ticket Section -->
                <div id="ticket-wrapper">
                    <div id="ticket" class="ticket-gradient text-white rounded-2xl shadow-2xl overflow-hidden text-left">
                       <div class="p-6">
                           <div class="flex justify-between items-start">
                               <div>
                                   <h1 class="text-3xl font-black uppercase tracking-wider">INSPIRA<span class="text-orange-300">'25</span></h1>
                                   <p class="text-orange-200">English Speech Club 23/24</p>
                                   <p class="text-xs text-gray-300">FAS, Rajarata University Of Sri Lanka.</p>
                               </div>
                               <img src="https://placehold.co/64x64/FFFFFF/541C1C?text=I25" class="h-16 w-16 rounded-full object-cover border-2 border-orange-300 p-1">
                           </div>
                           <div class="mt-8">
                               <p class="text-gray-300 text-sm uppercase">Admittee:</p>
                               <h2 id="ticket-name" class="text-2xl font-bold"></h2>
                               <p id="ticket-reg" class="text-gray-200"></p>
                           </div>
                           <div class="mt-6 border-t-2 border-dashed border-white/20 pt-6 flex justify-between items-center">
                               <div>
                                   <p class="text-gray-300 text-sm uppercase">Date & Time</p>
                                   <p class="font-semibold text-lg">Oct 1, 2025 | 09:00 AM</p>
                               </div>
                               <div>
                                   <p class="text-gray-300 text-sm uppercase text-right">Venue</p>
                                   <p class="font-semibold text-lg text-right">ZOOM</p>
                               </div>
                           </div>
                       </div>
                       <div class="bg-black/20 px-6 py-4 flex items-center justify-between">
                           <div>
                               <p class="text-xs text-gray-300">Ticket ID:</p>
                               <p id="ticket-id" class="font-mono text-sm"></p>
                           </div>
                           <div class="bg-white p-1 rounded-md">
                               <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://inspira2025web.github.io/inspiraweb" alt="QR Code" class="w-20 h-20">
                           </div>
                       </div>
                   </div>
                   <div class="mt-6 text-center">
                       <button id="download-ticket-btn" class="w-full md:w-auto btn-brand text-white font-bold py-3 px-8 rounded-lg text-lg">
                           <i class="bi bi-download mr-2"></i> Download Ticket
                       </button>
                   </div>
                </div>

                <!-- DP Section -->
                <div id="dp-wrapper">
                    <div class="dp-card text-white rounded-2xl shadow-2xl p-6 flex flex-col items-center justify-center h-full">
                         <h3 class="text-2xl font-bold mb-4">Profile Picture Generator</h3>
                         <p class="text-gray-300 mb-6">Download your profile picture for Zoom.</p>
                         <div class="relative w-48 h-48">
                            <canvas id="dp-canvas" width="512" height="512" class="rounded-full border-4 border-orange-400 shadow-lg absolute inset-0"></canvas>
                         </div>
                         <p class="mt-6 text-lg">Ready for Download!</p>
                         <div class="mt-6 text-center">
                             <button id="download-dp-btn" class="w-full md:w-auto btn-brand text-white font-bold py-3 px-8 rounded-lg text-lg">
                                 <i class="bi bi-download mr-2"></i> Download Picture
                             </button>
                         </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Firebase SDK -->
    <script type="module">
        // This is a placeholder for your Firebase configuration.
        // You will get this from the Firebase console and paste it here.
        // See the guide.md file for instructions.
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCr2cosjPXiSQH7aaedzthLv2E7kq0vclk",
  authDomain: "inspira-2.firebaseapp.com",
  projectId: "inspira-2",
  storageBucket: "inspira-2.firebasestorage.app",
  messagingSenderId: "470330649926",
  appId: "1:470330649926:web:703d628db10a3234e4c947"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        
        // --- DO NOT EDIT BELOW THIS LINE ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            sendEmailVerification,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- MOCK DATABASE (Simulating your Google Sheet) ---
        // In a real app, this check would happen on the server-side.
        // For this demo, we'll check it on the client side before sign-up.
        const registeredUsersSheet = [
            { regNumber: "ASP/2024/079", name: "Randika Subash", email: "randikaudayanga90@gmail.com" },
            { regNumber: "ASP/2024/065", name: "Janidu Chamupathi", email: "janidusenarathna157@gmail.com" },
            { regNumber: "ASP2024112", name: "Malith Sandeepa", email: "devilgamer167@gmail.com" },
            { regNumber: "ICT2024031", name: "Pasindu Dissanayake", email: "thinetpasindu@gmail.com" },
        ];
        
        function checkRegistration(regNumber, name, email) {
            const normalizedReg = regNumber.toUpperCase().replace(/\s/g, "");
            const normalizedName = name.toLowerCase().trim();
            const normalizedEmail = email.toLowerCase().trim();
            
            return registeredUsersSheet.some(user => 
                user.regNumber.toUpperCase().replace(/\s/g, "") === normalizedReg &&
                user.name.toLowerCase().trim() === normalizedName &&
                user.email.toLowerCase().trim() === normalizedEmail
            );
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Elements ---
        const loader = document.getElementById('loader');
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');

        const signinContainer = document.getElementById('signin-container');
        const signupContainer = document.getElementById('signup-container');
        const forgotContainer = document.getElementById('forgot-container');

        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const forgotForm = document.getElementById('forgot-form');

        const signinError = document.getElementById('signin-error');
        const signupError = document.getElementById('signup-error');
        const forgotError = document.getElementById('forgot-error');
        const forgotMessage = document.getElementById('forgot-message');
        
        // --- Form Switchers ---
        function showForm(formId) {
            document.querySelectorAll('.form-container').forEach(c => c.classList.remove('active'));
            document.getElementById(formId).classList.add('active');
        }
        
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); showForm('signup-container'); });
        document.getElementById('show-signin').addEventListener('click', (e) => { e.preventDefault(); showForm('signin-container'); });
        document.getElementById('show-signin-2').addEventListener('click', (e) => { e.preventDefault(); showForm('signin-container'); });
        document.getElementById('show-forgot').addEventListener('click', (e) => { e.preventDefault(); showForm('forgot-container'); });

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            loader.classList.remove('hidden');
            authSection.style.display = 'none';
            appSection.style.display = 'none';
            
            if (user) {
                if (user.emailVerified) {
                    // User is signed in and verified
                    loadUserData(user);
                } else {
                    // User is signed in but not verified
                    authSection.style.display = 'block';
                    showForm('signin-container');
                    signinError.textContent = 'Please verify your email address. A new verification email has been sent.';
                    signinError.classList.remove('hidden');
                    sendEmailVerification(user); // Resend verification email
                    loader.classList.add('hidden');
                }
            } else {
                // User is signed out
                authSection.style.display = 'block';
                showForm('signin-container');
                loader.classList.add('hidden');
            }
        });
        
        // Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reg = document.getElementById('signup-reg').value;
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            signupError.classList.add('hidden');

            // 1. Check if user is in our "Google Sheet"
            if (!checkRegistration(reg, name, email)) {
                signupError.textContent = "Registration details not found. Please double-check your information.";
                signupError.classList.remove('hidden');
                return;
            }

            // 2. Create user with Firebase Auth
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 3. Send email verification
                await sendEmailVerification(user);

                // 4. Save user data to Firestore
                await setDoc(doc(db, "users", user.uid), {
                    fullName: name,
                    regNumber: reg,
                    email: email,
                    ticketId: `INSP25-${Date.now().toString().slice(-6)}`
                });

                alert('Account created! Please check your email to verify your account before signing in.');
                signupForm.reset();
                showForm('signin-container');

            } catch (error) {
                signupError.textContent = error.message;
                signupError.classList.remove('hidden');
            }
        });

        // Sign In
        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            signinError.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the redirect
            } catch (error) {
                 signinError.textContent = error.message;
                 signinError.classList.remove('hidden');
            }
        });

        // Forgot Password
        forgotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            forgotError.classList.add('hidden');
            forgotMessage.classList.add('hidden');

            try {
                await sendPasswordResetEmail(auth, email);
                forgotMessage.textContent = 'Password reset email sent! Check your inbox.';
                forgotMessage.classList.remove('hidden');
                forgotForm.reset();
            } catch (error) {
                forgotError.textContent = error.message;
                forgotError.classList.remove('hidden');
            }
        });
        
        // Sign Out
        document.getElementById('signout-btn').addEventListener('click', async () => {
            await signOut(auth);
            // onAuthStateChanged will handle the view change
        });

        // --- App Logic (After Login) ---
        async function loadUserData(user) {
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    
                    // Populate UI with user data
                    document.getElementById('user-name-display').textContent = userData.fullName;
                    document.getElementById('ticket-name').textContent = userData.fullName;
                    document.getElementById('ticket-reg').textContent = userData.regNumber;
                    document.getElementById('ticket-id').textContent = userData.ticketId;
                    
                    // Generate and show DP
                    generateDP(userData.fullName, userData.regNumber);
                    
                    // Show the app
                    authSection.style.display = 'none';
                    appSection.style.display = 'block';
                    appSection.classList.remove('hidden');
                } else {
                    throw new Error("User data not found.");
                }

            } catch (error) {
                console.error("Error loading user data: ", error);
                alert("Could not load your data. Please try signing in again.");
                signOut(auth);
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        // --- Download Handlers ---
        document.getElementById('download-ticket-btn').addEventListener('click', function () {
            const ticketElement = document.getElementById('ticket');
            const studentName = document.getElementById('ticket-name').textContent.replace(/ /g, '_');
            const regNumber = document.getElementById('ticket-reg').textContent.replace(/\//g, '-');
            
            html2canvas(ticketElement, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `INSPIRA'25_Ticket_${regNumber}_${studentName}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.98);
                link.click();
            });
        });
        
        document.getElementById('download-dp-btn').addEventListener('click', function () {
             const canvas = document.getElementById('dp-canvas');
             const studentName = document.getElementById('ticket-name').textContent.replace(/ /g, '_');
             const regNumber = document.getElementById('ticket-reg').textContent.replace(/\//g, '-');

             const link = document.createElement('a');
             link.download = `INSPIRA'25_DP_${regNumber}_${studentName}.png`;
             link.href = canvas.toDataURL('image/png');
             link.click();
        });

        // --- DP Generator ---
        function generateDP(name, regNumber) {
            const canvas = document.getElementById('dp-canvas');
            const ctx = canvas.getContext('2d');
            const size = 512;

            // GitHub repo URL for images
            const imageUrl = 'https://raw.githubusercontent.com/inspira2025web/inspiraweb/photos/ST1001.jpg'; 
            
            const base_image = new Image();
            base_image.crossOrigin = "Anonymous"; // Important for CORS
            base_image.src = imageUrl;

            base_image.onload = function(){
                ctx.clearRect(0, 0, size, size);
                
                // Draw the template image
                ctx.drawImage(base_image, 0, 0, size, size);

                // Set text properties
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                
                // Draw Name
                ctx.font = 'bold 48px Poppins';
                ctx.fillText(name, size / 2, size - 90);
                
                // Draw Registration Number
                ctx.font = '36px Poppins';
                ctx.fillText(regNumber, size / 2, size - 45);
            }
            base_image.onerror = function() {
                // Fallback if image fails to load
                ctx.fillStyle = '#874C1B';
                ctx.fillRect(0, 0, size, size);
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.font = 'bold 48px Poppins';
                ctx.fillText(name, size / 2, 200);
                ctx.font = '36px Poppins';
                ctx.fillText(regNumber, size / 2, 250);
                console.error("Failed to load DP template image from GitHub.");
            }
        }
    </script>
</body>
</html>
